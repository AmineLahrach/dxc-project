<form [formGroup]="variableForm" class="space-y-8" (ngSubmit)="onSubmit()">
    <div class="bg-card rounded-2xl shadow p-6">
        <div class="flex items-center mb-6">
            <mat-icon class="text-primary mr-3" [svgIcon]="'heroicons_outline:variable'"></mat-icon>
            <h3 class="text-lg font-semibold">Variable Information</h3>
            <h5 class="text-primary ml-2" *ngIf="isEditMode">Variable weight: {{variableForm.get('poids').value}}</h5>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Description -->
            <mat-form-field class="md:col-span-2">
                <mat-label>Description</mat-label>
                <input matInput formControlName="description" placeholder="Enter variable description">
                <mat-error *ngIf="formControls.description.invalid && formControls.description.touched">
                    Description is required
                </mat-error>
            </mat-form-field>
           
            <mat-form-field class="md:col-span-2">
                <mat-label>Responsible Person</mat-label>
                <mat-select formControlName="responsable_id">
                    <mat-option *ngFor="let user of users" [value]="user.id">
                        {{user.prenom}} {{user.nom}}
                    </mat-option>
                </mat-select>
                <mat-error *ngIf="formControls.responsable_id.invalid && formControls.responsable_id.touched">
                    Responsible person is required
                </mat-error>
            </mat-form-field>
            <mat-form-field class="md:col-span-2">
                <mat-label>Action Plan</mat-label>
                <mat-select formControlName="plan_action_id">
                    <mat-option *ngFor="let plan of plans" [value]="plan.id">
                        {{plan.titre}}
                    </mat-option>
                </mat-select>
                <mat-error *ngIf="formControls.plan_action_id.invalid && formControls.plan_action_id.touched">
                    Action Plan is required
                </mat-error>
            </mat-form-field>
            <!-- Parent Variable (Optional) -->
            <mat-form-field class="md:col-span-2" *ngIf="variableActions.length > 0">
                <mat-label>Parent Variable (Optional)</mat-label>
                <mat-select formControlName="va_mere_id">
                    <mat-option [value]="">None</mat-option>
                    <ng-container *ngFor="let varAction of variableActions">
                        <!-- Disable the option if fige is true -->
                        <mat-option [value]="varAction.id" [disabled]="varAction.fige">
                            <!-- Add lock icon before displayLabel for fixed variables -->
                            <span class="flex items-center">
                                <mat-icon 
                                    *ngIf="varAction.fige" 
                                    class="mr-2 text-secondary icon-size-4" 
                                    [svgIcon]="'heroicons_outline:lock-closed'">
                                </mat-icon>
                                {{varAction.displayLabel}}
                            </span>
                        </mat-option>
                    </ng-container>
                </mat-select> 
                <mat-hint *ngIf="hasFixedVariables()">Locked variables stops adding children variable</mat-hint>               
            </mat-form-field>

             <div class="flex items-center">
                <!-- <mat-form-field class="flex-1"> -->
                    <mat-checkbox formControlName="fige">
                        Fixed Variable
                    </mat-checkbox>
                    <mat-icon 
                        class="ml-2 text-secondary"
                        matTooltip="Fixed variables does not allow adding more children variables"
                        [svgIcon]="'heroicons_outline:lock-closed'">
                    </mat-icon>
                    <mat-hint *ngIf="hasFixedVariables()"></mat-hint>
                <!-- </mat-form-field> -->
            </div>
        </div>
    </div>
    <!-- History & Activities -->
    <div class="bg-card rounded-2xl shadow p-6 mt-8" *ngIf="isEditMode">
        <div class="flex items-center mb-6">
            <mat-icon class="text-primary mr-3" [svgIcon]="'heroicons_outline:clock'"></mat-icon>
            <h3 class="text-lg font-semibold">History & Activities</h3>
        </div>
        <div class="space-y-4">
            <div *ngIf="!auditLogs?.length" class="text-center py-8">
                <div class="text-secondary">No activity history available</div>
            </div>
            <div *ngFor="let log of auditLogs | slice:0:logsToShow" class="flex space-x-4">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-sm font-medium">
                        {{ log.user.initials }}
                    </div>
                </div>
                <div class="flex-1">
                    <div class="flex items-center space-x-2">
                        <span class="font-medium">{{ log.user.name }}</span>
                        <span class="text-secondary text-sm">{{ log.action | titlecase }}</span>
                        <span class="text-secondary text-xs">{{ log.date }}</span>
                    </div>
                    <p class="text-sm mt-1">{{ log.details }}</p>
                </div>
            </div>
            <div class="text-center mt-4">
                <a *ngIf="auditLogs.length > logsToShow" class="text-blue-600 hover:underline cursor-pointer mr-4" (click)="viewAuditLogs()">Load More</a>
                <a *ngIf="logsToShow > 4" class="text-red-600 hover:underline cursor-pointer" (click)="collapseAuditLogs()">Collapse</a>
            </div>
        </div>
    </div>
    <!-- Form Actions -->
    <div class="flex items-center justify-end space-x-4">
        <button
            type="button"
            mat-stroked-button
            (click)="onCancel()">
            Cancel
        </button>
        <button
            type="submit"
            mat-flat-button
            color="primary"
            [disabled]="variableForm.invalid">
            <mat-spinner diameter="20" *ngIf="variableForm.pending"></mat-spinner>
            <mat-icon *ngIf="!variableForm.pending" [svgIcon]="'heroicons_outline:check'"></mat-icon>
            <span class="ml-2">{{isEditMode ? 'Update' : 'Create'}} Variable</span>
        </button>
    </div>
</form>